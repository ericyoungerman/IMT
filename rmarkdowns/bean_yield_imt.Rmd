---
title: "Bean Yield"

output:
  github_document:
    toc: true
always_allow_html: true


---
#Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE

)
```
#Packages
```{r}
# Packages ------------------------------------------------------------
library(tidyverse)    # includes dplyr, ggplot2, readr, tibble, etc.
library(janitor)
library(readxl)
library(glmmTMB)
library(DHARMa)
library(emmeans)
library(multcomp)
library(car)
library(kableExtra)
library(here)
library(conflicted)
library(lme4)
library(WrensBookshelf)

# Handle conflicts ----------------------------------------------------
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::recode)

# Global theme --------------------------------------------------------
theme_set(theme_bw(base_size = 12))

# Treatment level order (use everywhere) ------------------------------
mow_levels <- c(
  "No mowing",
  "Early mowing",
  "Late mowing",
  "As-needed mowing"
)

# One consistent CVD-safe color palette for all figures ---------------
fill_cols <- WB_brewer(
  name = "BlueberriesForSal",
  n    = length(mow_levels),
  type = "discrete"
) |>
  setNames(mow_levels)

# x-axis label helpers ------------------------------------------------

# Break on spaces (if you ever want every word on its own line)
label_break_spaces <- function(x) {
  stringr::str_replace_all(x, " ", "\n")
}

# Break after the comma: "Rolled,\nno control", etc.
label_break_comma <- function(x) {
  stringr::str_replace_all(x, ", ", ",\n")
}

# Break after comma AND split "high-residue cultivation"
# -> "Rolled,\nhigh-residue\ncultivation"
label_break_comma_cult <- function(x) {
  x |>
    stringr::str_replace("high-residue cultivation",
                         "high-residue\ncultivation") |>
    stringr::str_replace_all(", ", ",\n")
}

# Helper: tidy emmeans output regardless of CI column names -----------
# (works directly on an emmeans object)
# trt_var = name of treatment column to relevel (e.g., "weed_trt", "treatment")

tidy_emm <- function(emm, trt_var = NULL, ref_levels = NULL) {
  emm_df <- as.data.frame(emm)

  lcl_col <- intersect(c("lower.CL", "asymp.LCL"), names(emm_df))[1]
  ucl_col <- intersect(c("upper.CL", "asymp.UCL"), names(emm_df))[1]

  if (is.na(lcl_col) || is.na(ucl_col)) {
    stop("Could not find CI columns in emmeans output.")
  }

  out <- emm_df |>
    dplyr::mutate(
      ci_low  = .data[[lcl_col]],
      ci_high = .data[[ucl_col]]
    )

  if (!is.null(trt_var) && !is.null(ref_levels) && trt_var %in% names(out)) {
    out <- out |>
      dplyr::mutate(
        !!trt_var := factor(.data[[trt_var]], levels = ref_levels)
      )
  }

  out
}


```
# Data import
```{r}
#--- Yield conversions ---------------------------------------------------

# Constants
moisture_correction <- (100 - 0.00001) / (100 - 14)  # to 14% moisture
grams_per_lb        <- 454
sqft_per_acre       <- 43560
sample_area_sqft    <- 16.4
lb_per_kg           <- 2.20462
ac_per_ha           <- 2.47105          # 1 ha = 2.47105 ac
lb_ac_to_kg_ha      <- (1 / lb_per_kg) * ac_per_ha  # ≈ 1.12085

# Read + clean master, then compute adjusted yields ---------------------

bean_yield_clean <- read_excel(
  here("..", "raw-data", "combined_raw.xlsx"),
  na = c("na", "Na", "NA")
) |>
  clean_names() |>
  rename(weed_trt = treatment) |>
  mutate(
    year      = factor(year),
    location  = factor(location),
    site_year = factor(site_year),
    block     = factor(block),
    microplot = stringr::str_trim(microplot),
    weed_trt  = recode(
      weed_trt,
      "NWC" = "No mowing",
      "EWC" = "Early mowing",
      "LWC" = "Late mowing",
      "AWC" = "As-needed mowing"
    ),
    weed_trt = factor(weed_trt, levels = mow_levels)
  ) |>
  # keep rows with non-missing yield
  filter(!is.na(bean_yield)) |>
  # yield conversions: g per 16.4 ft² -> bu/ac, lb/ac, kg/ha
  mutate(
    # lb/ac at observed moisture
    bean_yield_lbs_acre = (bean_yield / grams_per_lb) /
      (sample_area_sqft / sqft_per_acre),

    # adjust to 14% moisture
    bean_yield_adj_lbs_acre = bean_yield_lbs_acre * moisture_correction,

    # bu/ac (60 lb/bu)
    bean_yield_adj_bu_acre = (bean_yield_adj_lbs_acre / 60),

    # kg/ha (corrected)
    bean_yield_adj_kg_ha = bean_yield_adj_lbs_acre * lb_ac_to_kg_ha
  )

```

## Subsets
```{r}
#---------------------------------------------------------------
# Analysis subsets for bean yield
#---------------------------------------------------------------

# 1) Add weediness factors (2-level and 3-level) ----------------

bean_yield_clean <- bean_yield_clean |>
  mutate(
    # 3-level weeds factor (for later NWC weed-free vs weedy work)
    weeds3 = dplyr::recode(
      microplot,
      "M"  = "Ambient weeds",
      "SW" = "Surrogate weeds",
      "WF" = "Weed-free",
      .default = NA_character_
    ),
    weeds3 = factor(
      weeds3,
      levels = c("Ambient weeds", "Surrogate weeds", "Weed-free")
    ),

    # 2-level weeds factor for balanced mowing × weeds analysis
    weeds2 = dplyr::recode(
      microplot,
      "M"  = "Ambient weeds",
      "SW" = "Surrogate weeds",
      .default = NA_character_
    ),
    weeds2 = factor(weeds2, levels = c("Ambient weeds", "Surrogate weeds"))
  )

# 2) Main yield dataset for mowing × weeds (ambient + surrogate) --------

bean_yield_bi <- bean_yield_clean |>
  filter(!is.na(weeds2))

# 3) No-mowing subset: weed-free vs weedy (for later comparison) --------

bean_yield_nwm_weedsfree <- bean_yield_clean |>
  filter(
    weed_trt == "No mowing",
    microplot %in% c("M", "SW", "WF")
  ) |>
  mutate(
    weed_status = dplyr::recode(
      microplot,
      "WF" = "Weed-free",
      "M"  = "Weedy",
      "SW" = "Weedy",
      .default = NA_character_
    ),
    weed_status = factor(weed_status, levels = c("Weedy", "Weed-free"))
  )

# Quick sanity checks ---------------------------------------------------

kable(
  head(bean_yield_bi),
  caption = "Bean yield dataset for mowing × weeds analysis (ambient + surrogate only)"
)

kable(
  head(bean_yield_nwm_weedsfree),
  caption = "No-mowing subset for weed-free vs weedy yield comparisons"
)

```

# Model testing
## Exploratory
```{r}
# 1) Summary table: bean yield by site-year × mowing --------------------
# (Ambient + surrogate weed microplots only; WF excluded)

bean_yield_bi |>
  group_by(site_year, weed_trt) |>
  summarise(
    n       = n(),
    mean    = mean(bean_yield_adj_kg_ha, na.rm = TRUE),
    median  = median(bean_yield_adj_kg_ha, na.rm = TRUE),
    sd      = sd(bean_yield_adj_kg_ha, na.rm = TRUE),
    .groups = "drop"
  ) |>
  arrange(site_year, weed_trt) |>
  kable(
    digits  = 1,
    caption = "Bean yield (kg ha⁻¹) by site-year × mowing treatment (ambient + surrogate weeds only)"
  ) |>
  kable_styling(
    full_width        = FALSE,
    bootstrap_options = c("striped", "hover")
  )

# 2) Faceted boxplot: bean yield across site-years ----------------------
# (Ambient + surrogate weed microplots only; WF excluded)

bean_yield_bi |>
  ggplot(aes(x = weed_trt, y = bean_yield_adj_kg_ha, fill = weed_trt)) +
  geom_boxplot(
    outlier.shape = NA,
    width         = 0.55,
    color         = "black"
  ) +
  geom_jitter(
    width  = 0.12,
    height = 0,
    alpha  = 0.4,
    size   = 1.8,
    color  = "grey30"
  ) +
  facet_wrap(~ site_year, nrow = 1) +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = label_break_spaces) +
  scale_y_continuous(labels = scales::label_comma()) +
  labs(
    x     = NULL,
    y     = expression(Bean~yield~"(kg"~ha^{-1}*")"),
    title = "Bean yield by mowing treatment across site-years (ambient + surrogate weeds)"
  ) +
  theme(
    axis.text.x = element_text(size = 10),
    strip.text  = element_text(face = "bold")
  )

```
## Selection
```{r}
## Selection
### Bean yield (kg ha⁻¹)

#### Pooled: mixed model for bean yield (kg ha⁻¹) ----------------------

options(contrasts = c("contr.sum", "contr.poly"))

# Fixed: mowing × weeds (ambient vs surrogate) + site_year
# Random: split-plot structure (site_year, block(site_year), mowing within block(site_year))

# Final bean-yield model (use this one downstream)
yield_lmm <- lmer(
  bean_yield_adj_kg_ha ~ weed_trt * weeds2 + site_year +
    (1 | site_year:block) +
    (1 | site_year:block:weed_trt),
  data = bean_yield_bi
)

# Quick model summary
summary(yield_lmm)

## Diagnostics -----------------------------------------------------------

set.seed(123)
res_yield <- DHARMa::simulateResiduals(yield_lmm)
plot(res_yield)
DHARMa::testDispersion(yield_lmm)
DHARMa::testZeroInflation(yield_lmm)

## Type-III tests --------------------------------------------------------

anova_yield <- car::Anova(yield_lmm, type = 3)
anova_yield


```

```{r}
### Bean yield (kg ha⁻¹) by mowing treatment (no CLDs)
### (ambient + surrogate weed microplots only)

# Estimated marginal means for weed_trt on the response scale (kg/ha)
emm_yield <- emmeans(
  yield_lmm,
  ~ weed_trt
)

# Use your tidy_emm helper to standardize CI columns
emm_yield_df <- tidy_emm(
  emm_yield,
  trt_var    = "weed_trt",
  ref_levels = mow_levels
) |>
  select(weed_trt, emmean, SE, ci_low, ci_high) |>
  mutate(
    across(c(emmean, SE, ci_low, ci_high), ~ round(.x, 1))
  )

emm_yield_df |>
  kable(
    caption   = "Estimated bean yield (kg ha⁻¹) by mowing treatment (ambient + surrogate weeds), with 95% CI from a linear mixed model. Mowing had no significant effect on yield (p = 0.16).",
    col.names = c("Treatment", "Mean", "SE", "Lower CI", "Upper CI")
  ) |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

```
## Equivalence testing
```{r}
## Equivalence testing
### Are mowing treatments "close enough" to the no-mowing control?

# 1) EMMs for bean yield -----------------------------------------------
emm_yield <- emmeans(yield_lmm, ~ weed_trt)

# Name of the control treatment (must match mow_levels exactly)
control_trt <- "No mowing"

# Extract treatment levels from emmGrid
trt_levels <- levels(emm_yield)$weed_trt

# Check the reference actually exists
if (!control_trt %in% trt_levels) {
  stop(
    "control_trt ('", control_trt, "') is not a level of weed_trt.\n",
    "Current levels are: ",
    paste(trt_levels, collapse = ", ")
  )
}

# 2) Define equivalence margin (as % of control yield) -----------------

# Model-based control yield (kg ha⁻¹)
control_mean <- summary(emm_yield) |>
  as_tibble() |>
  dplyr::filter(weed_trt == control_trt) |>
  dplyr::pull(emmean)

margin_pct <- 0.10        # e.g., 0.10 = ±10% of control yield
delta_kg   <- margin_pct * control_mean

# For interpretation: convert margin to bu ac⁻¹ (approx)
kg_per_bu_ac <- 67.25     # ≈ kg ha⁻¹ per 1 bu ac⁻¹ for dry bean (60 lb bu⁻¹)
delta_bu_ac  <- delta_kg / kg_per_bu_ac

cat(
  "Equivalence margin:",
  sprintf("±%.0f kg ha⁻¹ (≈ ±%.1f bu ac⁻¹, %.0f%% of No mowing yield)\n",
          delta_kg, delta_bu_ac, margin_pct * 100)
)

# 3) Contrasts: each treatment vs No mowing ----------------------------
yield_vs_control <- contrast(
  emm_yield,
  method = "trt.vs.ctrl",
  ref    = which(trt_levels == control_trt)
)

# 4) TOST-style equivalence tests via emmeans --------------------------
equiv_yield <- summary(
  yield_vs_control,
  infer  = c(TRUE, TRUE),     # show CI + tests
  level  = 0.90,              # 1 - 2*0.05 for α = 0.05 equivalence
  side   = "equivalence",     # two one-sided tests (TOST)
  delta  = delta_kg,
  adjust = "none"
) |>
  as_tibble() |>
  mutate(
    diff_bu_ac  = estimate / kg_per_bu_ac,
    lower_bu_ac = lower.CL / kg_per_bu_ac,
    upper_bu_ac = upper.CL / kg_per_bu_ac,
    p_equiv     = p.value
  )

# 5) Nicely formatted table for the Rmd --------------------------------
equiv_yield_table <- equiv_yield |>
  transmute(
    Contrast    = contrast,
    diff_kg_ha  = estimate,
    lower_kg_ha = lower.CL,
    upper_kg_ha = upper.CL,
    diff_bu_ac,
    lower_bu_ac,
    upper_bu_ac,
    p_equiv
  ) |>
  mutate(
    across(
      c(diff_kg_ha, lower_kg_ha, upper_kg_ha,
        diff_bu_ac, lower_bu_ac, upper_bu_ac),
      ~ round(.x, 1)
    ),
    p_equiv = signif(p_equiv, 3)
  ) |>
  kable(
    caption = paste0(
      "Equivalence tests for bean yield vs ",
      control_trt,
      " (margin = ±",
      round(delta_kg, 0), " kg ha⁻¹ ≈ ±",
      round(delta_bu_ac, 1), " bu ac⁻¹; ",
      round(margin_pct * 100), "% of control yield)."
    ),
    col.names = c(
      "Contrast",
      "Difference (kg ha⁻¹)", "Lower 90% CI", "Upper 90% CI",
      "Difference (bu ac⁻¹)", "Lower 90% CI", "Upper 90% CI",
      "p (equiv.)"
    )
  ) |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

equiv_yield_table

```
```{r}
## Equivalence testing
### Are other mowing treatments "close enough" to Early mowing?

# 1) EMMs for bean yield -----------------------------------------------
emm_yield <- emmeans(yield_lmm, ~ weed_trt)

# Name of the reference treatment (must match mow_levels exactly)
control_trt <- "Early mowing"

# Extract treatment levels from emmGrid
trt_levels <- levels(emm_yield)$weed_trt

# Check the reference actually exists
if (!control_trt %in% trt_levels) {
  stop(
    "control_trt ('", control_trt, "') is not a level of weed_trt.\n",
    "Current levels are: ",
    paste(trt_levels, collapse = ", ")
  )
}

# 2) Define equivalence margin (as % of Early mowing yield) ------------

# Model-based Early mowing yield (kg ha⁻¹)
control_mean <- summary(emm_yield) |>
  as_tibble() |>
  dplyr::filter(weed_trt == control_trt) |>
  dplyr::pull(emmean)

margin_pct <- 0.10        # e.g., 0.10 = ±10% of Early mowing yield
delta_kg   <- margin_pct * control_mean

# For interpretation: convert margin to bu ac⁻¹ (approx)
kg_per_bu_ac <- 67.25     # ≈ kg ha⁻¹ per 1 bu ac⁻¹ for dry bean (60 lb bu⁻¹)
delta_bu_ac  <- delta_kg / kg_per_bu_ac

cat(
  "Equivalence margin:",
  sprintf("±%.0f kg ha⁻¹ (≈ ±%.1f bu ac⁻¹, %.0f%% of %s yield)\n",
          delta_kg, delta_bu_ac, margin_pct * 100, control_trt)
)

# 3) Contrasts: each treatment vs Early mowing -------------------------
yield_vs_control <- contrast(
  emm_yield,
  method = "trt.vs.ctrl",
  ref    = which(trt_levels == control_trt)
)

# 4) TOST-style equivalence tests via emmeans --------------------------
equiv_yield <- summary(
  yield_vs_control,
  infer  = c(TRUE, TRUE),     # show CI + tests
  level  = 0.90,              # 1 - 2*0.05 for α = 0.05 equivalence
  side   = "equivalence",     # two one-sided tests (TOST)
  delta  = delta_kg,
  adjust = "none"
) |>
  as_tibble() |>
  mutate(
    diff_bu_ac  = estimate / kg_per_bu_ac,
    lower_bu_ac = lower.CL / kg_per_bu_ac,
    upper_bu_ac = upper.CL / kg_per_bu_ac,
    p_equiv     = p.value
  )

# 5) Nicely formatted table for the Rmd --------------------------------
equiv_yield_table <- equiv_yield |>
  transmute(
    Contrast    = contrast,
    diff_kg_ha  = estimate,
    lower_kg_ha = lower.CL,
    upper_kg_ha = upper.CL,
    diff_bu_ac,
    lower_bu_ac,
    upper_bu_ac,
    p_equiv
  ) |>
  mutate(
    across(
      c(diff_kg_ha, lower_kg_ha, upper_kg_ha,
        diff_bu_ac, lower_bu_ac, upper_bu_ac),
      ~ round(.x, 1)
    ),
    p_equiv = signif(p_equiv, 3)
  ) |>
  kable(
    caption = paste0(
      "Equivalence tests for bean yield vs ",
      control_trt,
      " (margin = ±",
      round(delta_kg, 0), " kg ha⁻¹ ≈ ±",
      round(delta_bu_ac, 1), " bu ac⁻¹; ",
      round(margin_pct * 100), "% of ", control_trt, " yield)."
    ),
    col.names = c(
      "Contrast",
      "Difference (kg ha⁻¹)", "Lower 90% CI", "Upper 90% CI",
      "Difference (bu ac⁻¹)", "Lower 90% CI", "Upper 90% CI",
      "p (equiv.)"
    )
  ) |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

equiv_yield_table

```

# Figures
## Pooled
```{r}

#### Raw means (kg ha⁻¹)
### Figure: Bean yield by mowing treatment (raw means ± SE)
### (ambient + surrogate weed microplots only)

# 1) Raw means and SE by treatment --------------------------------------
raw_yield_summary <- bean_yield_bi |>
  group_by(weed_trt) |>
  summarise(
    n    = n(),
    mean = mean(bean_yield_adj_kg_ha, na.rm = TRUE),
    sd   = sd(bean_yield_adj_kg_ha, na.rm = TRUE),
    se   = sd / sqrt(n),
    .groups = "drop"
  ) |>
  mutate(
    weed_trt = factor(weed_trt, levels = mow_levels),
    ymin     = pmax(mean - se, 0),
    ymax     = mean + se
  )

# 2) Plot ---------------------------------------------------------------
ggplot(raw_yield_summary, aes(x = weed_trt, y = mean, fill = weed_trt)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.14) +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = label_break_spaces) +
  scale_y_continuous(labels = scales::label_comma()) +
  labs(
    x       = NULL,
    y       = expression(Bean~yield~"(kg"~ha^{-1}*")"),
    title   = "Bean yield by mowing treatment"
    
  ) +
  theme_classic(base_size = 18) +
  theme(
    axis.text.x  = element_text(lineheight = 0.95, margin = margin(t = 8)),
    axis.title.y = element_text(margin = margin(r = 8)),
    plot.title   = element_text(face = "bold"),
    plot.caption = element_text(size = 9, hjust = 0)
  )

# 3) Save figure --------------------------------------------------------
ggsave(
  filename = here("figures", "fig_bean_yield_mowing_pooled_raw.png"),
  width    = 9,
  height   = 5.5,
  dpi      = 300
)

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries

```{r message=FALSE, warning=FALSE}

#Set work directory
setwd("/Users/ey239/Github/IMT/rmarkdowns")

#Load packages 
library(tidyverse) ##install.packages("tidyverse")
library(knitr)
library(patchwork) ##install.packages("patchwork")
library(skimr)     ##install.packages("skimr")
library(readxl)
library(janitor) ##install.packages("janitor")

library(kableExtra) ##install.packages("kableExtra")
library(webshot) ##install.packages("webshot")
webshot::install_phantomjs()
library(viridis) ##install.packages("viridis")
library(lme4) ##install.packages("lme4")
library(lmerTest) ##install.packages("lmerTest")
library(emmeans) ##install.packages("emmeans")
library(rstatix) ##install.packages("rstatix")
#library(Matrix) ##install.packages("Matrix")
library(multcomp) ##install.packages("multcomp")
library(multcompView) ##install.packages("multcompView")
library(ggResidpanel) ##install.packages("ggResidpanel")
#library(car)
#library(TMB)  ##install.packages("TMB")
library(glmmTMB)  ##install.packages("glmmTMB")
library(DHARMa)  ##install.packages("DHARMa")
library(performance) ##install.packages("performance")
library(WrensBookshelf)##install.packages("WrensBookshelf")
#Load Functions
MeanPlusSe<-function(x) mean(x)+plotrix::std.error(x)

find_logw0=function(x){c=trunc(log(min(x[x>0],na.rm=T)))
d=exp(c)
return(d)}
```


<br>

# Load and clean data

## Load data

``` {r}
combined_raw <- read_excel("~/Github/IMT/raw-data/combined_raw.xlsx")
kable(head(combined_raw))

```




##Clean data
###ECOBEAN (all sites)
```{r}
## Standardize column names and convert variables
clean_combined <- combined_raw |>  
  clean_names() |>  
  rename(mowing = treatment, weeds = microplot) |> 
  mutate(
    across(c(year, location, site_year, mowing, block, plot, weeds), as.factor),
    bean_yield = as.numeric(bean_yield)  # Convert to numeric safely
  )

# Define constants for yield conversion
moisture_correction <- (100 - 0.00001) / (100 - 14)
kg_to_lb <- 2.20462
sqft_per_acre <- 43560
sample_area_sqft <- 16.4
grams_per_lb <- 454

# Filter relevant data and compute adjusted yields
bean_yield_clean <- clean_combined |>  
  filter(
    weeds %in% c("SW", "M"), 
    !is.na(bean_yield)
  ) |>  
  mutate(
    bean_yield_adj_bu_acre = (((bean_yield / grams_per_lb) / (sample_area_sqft / sqft_per_acre)) / 60) * moisture_correction,
    bean_yield_adj_lbs_acre = ((bean_yield / grams_per_lb) / (sample_area_sqft / sqft_per_acre)) * moisture_correction,
    bean_yield_adj_kg_ha = bean_yield_adj_lbs_acre / kg_to_lb
  )

# Display cleaned dataset
kable(head(bean_yield_clean))

```

###FARMHUB 2024 REPORT (Musgrave and Farmhub)
```{r}
## Standardize column names, convert to factors, and check for outliers
clean_combined <- combined_raw |>  
  clean_names() |>  
  rename(mowing = treatment, weeds = microplot) |> 
  mutate(
    across(c(year, location, site_year, mowing, block, plot, weeds), as.factor),
    bean_yield = as.numeric(bean_yield) # Convert to numeric safely
  ) 

# Define constants for yield conversion
moisture_correction <- (100 - 0.00001) / (100 - 14)
kg_to_lb <- 2.20462
sqft_per_acre <- 43560
sample_area_sqft <- 16.4
grams_per_lb <- 454

# Filter relevant data and compute adjusted yields
bean_yield_clean_fh <- clean_combined |>  
  filter(
    weeds %in% c("SW", "M"), 
    location %in% c("FH", "CU"), 
    year == "2024", 
    !is.na(bean_yield)
  ) |>  
  mutate(
    bean_yield_adj_bu_acre_fh = (((bean_yield / grams_per_lb) / (sample_area_sqft / sqft_per_acre)) / 60) * moisture_correction,
    bean_yield_adj_lbs_acre_fh = ((bean_yield / grams_per_lb) / (sample_area_sqft / sqft_per_acre)) * moisture_correction,
    bean_yield_adj_kg_ha_fh = bean_yield_adj_lbs_acre_fh / kg_to_lb
  )

# Display cleaned dataset
kable(bean_yield_clean_fh)
```
###FARMHUB REPORT (Musgrave and Farm hub, NWC only)
```{r}
# Standardize column names and convert variables
clean_combined <- combined_raw |>  
  clean_names() |>  
  rename(mowing = treatment, weeds = microplot) |> 
  mutate(
    across(c(year, location, site_year, mowing, block, plot, weeds), as.factor),
    bean_yield = as.numeric(bean_yield)  # Convert to numeric safely
  )

# Define constants for yield conversion
moisture_correction <- (100 - 0.00001) / (100 - 14)
kg_to_lb <- 2.20462
sqft_per_acre <- 43560
sample_area_sqft <- 16.4
grams_per_lb <- 454

# Filter relevant data and compute adjusted yields
bean_yield_clean_fh_wf <- clean_combined |>  
  filter(
    location %in% c("FH", "CU"),
    year == "2024",
    mowing == "NWC",
    !is.na(bean_yield)
  ) |>  
  mutate(
    bean_yield_adj_bu_acre_fh_wf = (((bean_yield / grams_per_lb) / (sample_area_sqft / sqft_per_acre)) / 60) * moisture_correction,
    bean_yield_adj_lbs_acre_fh_wf = ((bean_yield / grams_per_lb) / (sample_area_sqft / sqft_per_acre)) * moisture_correction,
    bean_yield_adj_kg_ha_fh_wf = bean_yield_adj_lbs_acre_fh_wf / kg_to_lb
  )

# Display cleaned dataset
kable(bean_yield_clean_fh_wf)
```
# Model testing
##ECOBEAN
### Lmer

```{r}

# This is better for providing generalizations and recommendations. Location can be used as a random effect since we have 5 locations, (if need be, we can )

random_eco <- lmer(bean_yield_adj_bu_acre ~ mowing*weeds  + (1|location) + (1|location:block)+  (1|location:block:mowing), data = bean_yield_clean)


#tyler whats up with uri being random? location*year takes into accoutn if we are concerned about only these years and locations, everything is relative to the ten means from this experiment

#random_uri <- lmer(bean_yield_adj_kg_ha  ~ mowing*weeds + location*year + (1|site_year:block)+  (1|site_year:block:mowing)  , data =  bean_yield_clean)


resid_panel(random_eco)

simulateResiduals(random_eco,plot = TRUE) # Residuals and normality look good
check_model(random_eco)
```

### Joint test (anova)
```{r}
 random_eco |> 
  joint_tests() |> 
  kable()  
```
### Anova table
```{r}
options(contrasts = c("contr.sum", "contr.poly"))
Anova(random_eco, type = 3)
```
### Fisher compact letter display
#### Weed-control (No significant)

```{r}
tukey_mowing <- emmeans(random_eco, list(pairwise ~ mowing), adjust = "tukey")
tukey_mowing

cld_mowing_tukey <- cld(emmeans(random_eco, ~ mowing), adjust = "tukey", Letters = letters, sort = TRUE, reversed = TRUE)

cld_mowing_tukey
```



#### Weeds (significant)

```{r}


tukey_weeds <- emmeans(random_eco, list(pairwise ~ weeds), adjust = "tukey")
tukey_weeds

cld_weeds_tukey <- cld(emmeans(random_eco, ~ weeds), adjust = "tukey", Letters = letters, sort = TRUE, reversed = TRUE)

cld_weeds_tukey
```

##FARMHUB REPORT
### Lmer
Block is random
Tyler is under the impression that block should always be random and that post-hoc comparisons should use TUKEY rather the Fischer. Fisher is bogus apparently. 

```{r}

# This is better for providing generalizatins and reccomendations. 

random_fh <- lmer(bean_yield_adj_bu_acre_fh ~ mowing*weeds*location+ (1|location:block)+  (1|location:block:mowing), data = bean_yield_clean_fh)


#tyler whats up with uri being random? location*year takes into accoutn if we are concerned about only these years and locations, everything is relative to the ten means from this experiment

#random_uri <- lmer(bean_yield_adj_kg_ha  ~ mowing*weeds + location*year + (1|site_year:block)+  (1|site_year:block:mowing)  , data =  bean_yield_clean)


resid_panel(random_fh)

simulateResiduals(random_fh,plot = TRUE) # Residuals and normality look good
check_model(random_fh)
```

### Joint test (anova)
```{r}
 random_fh |> 
  joint_tests() |> 
  kable()  
```
### Anova table
```{r}
options(contrasts = c("contr.sum", "contr.poly"))
Anova(random_fh, type = 3)
```
### Fisher compact letter display
#### Weed-control (No significant)

```{r}
cld_mowing_fisher_fh <-cld(emmeans(random_fh, ~  mowing , type = "response"), Letters = letters, adjust = "none",sort = TRUE, reversed=TRUE)
cld_mowing_fisher_fh
```

#### Weeds (significant)

```{r}
cld_weeds_fisher_fh <-cld(emmeans(random_fh, ~  weeds , type = "response"), Letters = letters, adjust = "none",sort = TRUE, reversed=TRUE)
cld_weeds_fisher_fh
```
#### Weeds by location (significant)

```{r}
cld_location_fisher_fh <-cld(emmeans(random_fh, ~ location , type = "response"), Letters = letters, adjust = "none",sort = TRUE, reversed=TRUE)
cld_location_fisher_fh
```
#### Mowing by location (not significant)

```{r}
cld_mowing_weeds_location_fisher_fh <-cld(emmeans(random_fh, ~  mowing|weeds|location , type = "response"), Letters = letters, adjust = "none",sort = TRUE, reversed=TRUE)
cld_mowing_weeds_location_fisher_fh
```
##FARMHUB REPORT weed free
### Lmer

```{r}

# This is better for providing generalizatins and reccomendations. 

random_fh_wf <- lmer(bean_yield_adj_bu_acre_fh_wf ~ weeds*location+ (1|location:block)+  (1|location:block:mowing), data = bean_yield_clean_fh_wf)


#tyler whats up with uri being random? location*year takes into accoutn if we are concerned about only these years and locations, everything is relative to the ten means from this experiment

#random_uri <- lmer(bean_yield_adj_kg_ha  ~ mowing*weeds + location*year + (1|site_year:block)+  (1|site_year:block:mowing)  , data =  bean_yield_clean)


resid_panel(random_fh_wf)

simulateResiduals(random_fh_wf,plot = TRUE) # Residuals and normality look good
check_model(random_fh_wf)
```
### Joint test (anova)
```{r}
 random_fh_wf |> 
  joint_tests() |> 
  kable()  
```

#### Weeds (Significant)

```{r}
cld_weeds_fisher_fh_wf <-cld(emmeans(random_fh_wf, ~  weeds , type = "response"), Letters = letters, adjust = "none",sort = TRUE, reversed=TRUE)
cld_weeds_fisher_fh_wf
```
#### Weeds by location (not significant)

```{r}
cld_weeds_location_fisher_fh_wf <-cld(emmeans(random_fh_wf, ~  weeds|location , type = "response"), Letters = letters, adjust = "none",sort = TRUE, reversed=TRUE)
cld_weeds_location_fisher_fh_wf
```
#### Weeds by location (not significant)

```{r}
cld_location_weeds_fisher_fh_wf <-cld(emmeans(random_fh_wf, ~  location|weeds , type = "response"), Letters = letters, adjust = "none",sort = TRUE, reversed=TRUE)
cld_location_weeds_fisher_fh_wf
```
#Figures
##ECOBEAN

### Mowing on yield (not significant)

```{r message=FALSE}
bean_yield_clean |> 
  left_join(cld_mowing_tukey) |> 
  ggplot(aes(x = factor(mowing, levels = c("NWC", "EWC", "LWC", "AWC")), y = bean_yield_adj_bu_acre, fill = mowing)) +
  stat_summary(geom = "bar", fun = "mean", width = 0.7) +
  stat_summary(geom = "errorbar", fun.data = "mean_se", width = 0.2) +
  #stat_summary(geom="text", fun = "MeanPlusSe", aes(label= trimws(.group)),size=6.5,vjust=-0.5) +
  #geom_bar(stat="identity", position=position_dodge()) + 
  #geom_errorbar(aes(ymin=response-SE, ymax=response+SE), width=.2,
                 #position=position_dodge(.9))+
#geom_text(aes(label = trimws(.group), y = response + (SE + 30)), size = 7) +
  labs(
    x = "",
       y = expression(paste("Dry bean yield (", bu/a, " at 14% moisture)")),
    subtitle = expression(italic("Not significant"))) +
  
  scale_x_discrete(labels = c("No\nmowing", "Early\nmowing", "Late\nmowing", "As-needed\nmowing")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +
   theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 12),
    axis.title = element_text(size = 24),  # Increase font size of axis titles
    axis.text = element_text(size = 24),   # Increase font size of axis labels
    plot.title = element_text(size = 24, face = "bold"),  # Increase font size of title
    plot.subtitle = element_text(size = 24, face = "italic")  # Increase font size of subtitle
  
  )
ggsave("bean_yield_mowing_buac_eco.png", width = 10, height = 8, dpi = 300)
```
### Weed level of yield (significant)

```{r message=FALSE}
bean_yield_clean |> 
  left_join(cld_weeds_tukey) |> 
  ggplot(aes(x = weeds, y = bean_yield_adj_bu_acre, fill = weeds)) +  # Fill added
  stat_summary(geom = "bar", fun = "mean", width = 0.6, position = position_dodge(width = 0.7)) +
  stat_summary(geom = "errorbar", fun.data = "mean_se", width = 0.2, position = position_dodge(width = 0.7)) +
  stat_summary(geom = "text", fun = "MeanPlusSe", aes(label = trimws(.group)), 
               size = 6.5, vjust = -0.5, position = position_dodge(width = 0.7)) +
  labs(
    x = "",
    y = expression(paste("Dry bean yield (", bu/a, " at 14% moisture)")),
  subtitle = expression(italic("P < 0.001"))
  ) +
  scale_x_discrete(labels = c("Ambient weeds", "Surrogate + ambient weeds")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +  # Ensure correct function use
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 20),
    axis.title = element_text(size = 24),
    axis.text = element_text(size = 20),
    plot.title = element_text(size = 24, face = "bold"),
    plot.subtitle = element_text(size = 24, face = "italic")
  )
ggsave("bean_yield_weeds_buac_eco.png", width = 10, height = 8, dpi = 300)
```


## FARMHUB REPORT
### Mowing on yield
```{r message=FALSE}
bean_yield_clean_fh |> 
  left_join(cld_mowing_fisher_fh) |> 
  ggplot(aes(x = factor(mowing, levels = c("NWC", "EWC", "LWC", "AWC")), 
             y = bean_yield_adj_bu_acre_fh, fill = mowing)) + 
  stat_summary(geom = "bar", fun = "mean", width = 0.6) +
  stat_summary(geom = "errorbar", fun.data = "mean_se", width = 0.2) +
  labs(
    x = "",
    y = expression(paste("Dry bean yield (", "bu/a", " at 14% moisture)"))) +
  scale_x_discrete(labels = c("No\nmowing", "Early\nmowing", "Late\nmowing", "As-needed\nmowing")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +  
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 12),
    axis.title = element_text(size = 24),
    axis.text = element_text(size = 24),
    plot.title = element_text(size = 24, face = "bold"),
    plot.subtitle = element_text(size = 24, face = "italic")
  )

ggsave("bean_yield_mowing_bua_fh.png", width = 10, height = 8, dpi = 300)
```
### Weed level on yield (significant)

```{r message=FALSE}
bean_yield_clean_fh_wf |> 
  left_join(cld_weeds_fisher_fh_wf) |> 
  ggplot(aes(x = factor(weeds, levels = c("WF", "M", "SW")), y = bean_yield_adj_bu_acre_fh_wf, fill = weeds)) +  # Fill added
  stat_summary(geom = "bar", fun = "mean", width = 0.6, position = position_dodge(width = 0.7)) +
  stat_summary(geom = "errorbar", fun.data = "mean_se", width = 0.2, position = position_dodge(width = 0.7)) +
  stat_summary(geom = "text", fun = "MeanPlusSe", aes(label = trimws(.group)), 
               size = 6.5, vjust = -0.5, position = position_dodge(width = 0.7)) +
  labs(
    x = "",
   y = expression(paste("Dry bean yield (", "bu/a", " at 14% moisture)"))) +
  scale_x_discrete(labels = c("Weed free", "Ambient weeds", "Surrogate + ambient weeds")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +  # Ensure correct function use
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 20),
    axis.title = element_text(size = 24),
    axis.text = element_text(size = 20),
    plot.title = element_text(size = 24, face = "bold"),
    plot.subtitle = element_text(size = 24, face = "italic")
  )
ggsave("bean_yield_weeds_bhac_fh.png", width = 10, height = 8, dpi = 300)
```

### Weed level and location (not significant)

```{r message=FALSE}
bean_yield_clean_fh_wf |> 
  left_join(cld_weeds_location_fisher_fh_wf) |> 
  ggplot(aes(x = factor(weeds, levels = c("WF", "M", "SW")), y = bean_yield_adj_bu_acre_fh_wf, fill = weeds)) + facet_wrap(~location, ncol= 2, labeller = labeller(location = c("CU" = "Cornell Musgrave Research Farm", "FH" = "Hudson Valley Farm Hub"))) + # Fill added
  stat_summary(geom = "bar", fun = "mean", width = 0.6, position = position_dodge(width = 0.7)) +
  stat_summary(geom = "errorbar", fun.data = "mean_se", width = 0.2, position = position_dodge(width = 0.7)) +
  stat_summary(geom = "text", fun = "MeanPlusSe", aes(label = trimws(.group)), 
               size = 6.5, vjust = -0.5, position = position_dodge(width = 0.7)) +
  labs(
    x = "",
   y = expression(paste("Dry bean yield (", "bu/a", " at 14% moisture)")),
  subtitle = expression(italic("P < 0.005"))
  ) +
  scale_x_discrete(labels = c("Weed free", "Ambient \nweeds", "Surrogate + \nambient weeds")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +  # Ensure correct function use
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 20),
    axis.title = element_text(size = 24),
    axis.text = element_text(size = 20),
    plot.title = element_text(size = 24, face = "bold"),
    plot.subtitle = element_text(size = 24, face = "italic")
  )
ggsave("bean_yield_weeds_location_bhac_fh.png", width = 10, height = 10, dpi = 300)
```