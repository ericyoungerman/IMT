---
title: "Dry bean population"

output:
  github_document:
    toc: true
always_allow_html: true

---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.path = "analysis/figs/bean_population-"
)
```
# Load libraries


```{r message=FALSE, warning=FALSE}
# Packages ------------------------------------------------------------
library(tidyverse)
library(janitor)
library(readxl)
library(glmmTMB)
library(DHARMa)
library(emmeans)
library(multcomp)
library(car)
library(kableExtra)
library(here)
library(conflicted)
library(lme4)
library(WrensBookshelf)

# Handle conflicts ----------------------------------------------------
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::recode)

# Global theme --------------------------------------------------------
theme_set(theme_bw(base_size = 12))

# Mowing treatment levels (use everywhere) ----------------------------
mow_levels <- c(
  "No mowing",
  "Early mowing",
  "Late mowing",
  "As-needed mowing"
)

# Color palette -------------------------------------------------------
fill_cols <- WB_brewer(
  name = "BlueberriesForSal",
  n    = length(mow_levels),
  type = "discrete"
) |>
  setNames(mow_levels)

# Label helpers -------------------------------------------------------
label_break_spaces <- function(x) {
  stringr::str_replace_all(x, " ", "\n")
}

label_break_comma <- function(x) {
  stringr::str_replace_all(x, ", ", ",\n")
}

label_break_comma_cult <- function(x) {
  x |>
    stringr::str_replace("high-residue cultivation",
                         "high-residue\ncultivation") |>
    stringr::str_replace_all(", ", ",\n")
}

# Generic emmeans tidy helper -----------------------------------------
tidy_emm <- function(emm, trt_var = NULL, ref_levels = NULL) {
  emm_df <- as.data.frame(emm)

  lcl_col <- intersect(c("lower.CL", "asymp.LCL"), names(emm_df))[1]
  ucl_col <- intersect(c("upper.CL", "asymp.UCL"), names(emm_df))[1]

  if (is.na(lcl_col) || is.na(ucl_col)) {
    stop("Could not find CI columns in emmeans output.")
  }

  out <- emm_df |>
    dplyr::mutate(
      ci_low  = .data[[lcl_col]],
      ci_high = .data[[ucl_col]]
    )

  if (!is.null(trt_var) && !is.null(ref_levels) && trt_var %in% names(out)) {
    out <- out |>
      dplyr::mutate(
        !!trt_var := factor(.data[[trt_var]], levels = ref_levels)
      )
  }

  out
}

```

<br>

# Load and clean data

## Load data

``` {r}
combined_raw <- read_excel("~/Github/IMT/raw-data/combined_raw.xlsx")
kable(head(combined_raw))

```

##FARMHUB 2024 REPORT (Musgrave and Farmhub only)
```{r}
# Constants for conversion
row_spacing_m <- 0.762                # 30-inch rows
acre_m2 <- 4046.86                    # Square meters per acre
row_m_per_acre <- acre_m2 / row_spacing_m  # â‰ˆ 5311.5 meters of row per acre

# Clean and convert bean population data
bean_population_clean_fh <- combined_raw |>  
  clean_names() |>  
  rename(mowing = treatment, weeds = microplot) |> 
  mutate(across(c(year, location, site_year, mowing, block, plot, weeds), as.factor)) |> 
  filter(
    weeds %in% c("SW", "M"),
    location %in% c("FH", "CU")
  ) |>  
  mutate(
    bean_population = as.numeric(bean_population),  # ensure numeric
    bean_pop_plants_acre = bean_population * row_m_per_acre
  )

# Preview result
kable(head(bean_population_clean_fh))

```

##FARMHUB 2024 REPORT (Musgrave and Farmhub only)
### Glmm
```{r}

random_fh <- lmer(bean_pop_plants_acre ~ mowing*weeds*location+ (1|location:block)+  (1|location:block:mowing), data = bean_population_clean_fh)
resid_panel(random_fh)

simulateResiduals(random_fh,plot = TRUE) # Residuals and normality look good
check_model(random_fh)






```

### Joint test (anova)
```{r}
 random_fh |> 
  joint_tests() |> 
  kable()  
```

### Fisher compact letter display
#### Weed-control (No significant)

```{r}
cld_mowing_fisher_fh <-cld(emmeans(random_fh, ~  mowing , type = "response"), Letters = letters, adjust = "none",sort = TRUE, reversed=TRUE)
cld_mowing_fisher_fh
```